# Arena Clash — Game Design Document

**Платформа:** Minecraft 1.21.1, Fabric  
**Жанр:** Tower Defense / Auto-battler / Survival  
**Режим:** 1v1, потенциально 2v2 или 1v1v1

---

## 1. Концепция

Arena Clash — это мод для Minecraft, вдохновлённый Clash Royale. Два игрока собирают ресурсы и охотятся на мобов в отдельных сурвайвал-мирах, получая «карточки» убитых мобов. Затем они размещают этих мобов на трёхполосной арене, где те автоматически сражаются друг с другом, атакуя вражеские башни и трон.

### Уникальная особенность

В отличие от классического Clash Royale, здесь сила армии зависит от навыков выживания: чем больше и опаснее мобов ты убил — тем сильнее твоя армия. Minecraft-сурвайвал становится фазой «фарма», а арена — фазой «битвы».

### Целевая аудитория

Игроки Minecraft, которым нравится PvP, tower defense и стратегические мини-игры. Мод рассчитан на сессии по 15–30 минут.

---

## 2. Игровой цикл

### 2.1. Общая структура

Игра состоит из **3 раундов** (настраивается). Каждый раунд проходит три фазы:

```
┌───────────────────────────────────────────┐
│                       РАУНД N             │
│                                           │
│  SURVIVAL ──→ PREPARATION ──→ BATTLE      │
│  (фарм)       (расстановка)   (бой)       │
│                                           │
│  Сингл        Арена-сервер    Арена-сервер│
│  по TCP       по MC+TCP       по MC+TCP   │
└───────────────────────────────────────────┘
```

### 2.2. Фаза Survival (Выживание)

**Где:** Отдельный сингл-мир у каждого игрока (одинаковый сид).  
**Длительность:** R1 = 1 игровой день, R2 = 2, R3 = 3 (по ~5 мин реального времени за день).  
**Цель:** Убивать мобов, собирать карточки, экипироваться.

Особенности фазы:
- **Ускоренный цикл дня**: ванильный день (24000 тиков) сжимается до 6000 тиков (5 мин).
- **Авто-плавка руд**: При вскапывании сырое железо → слиток, сырое золото → слиток, сырая медь → слиток, древний обломок → незеритовый скрап. Работает с Fortune (множит слитки), не затрагивает Silk Touch.
- **XP отключён**: сферы опыта не появляются и не собираются. XP зарабатывается другим путем и служит валютой для прокачки.
- **Мобы из спаунеров** отмечены надписью «✘ Spawner». Они **не дают карточек** (чтобы не фармить бесконечно у спаунера).
- **Инвентарь синхронизируется** между сингл-миром и ареной через TCP.

### 2.3. Фаза Preparation (Подготовка)

**Где:** Арена на выделенном MC-сервере.
**Длительность:** 3 минуты (или оба игрока нажали «Готов»).
**Цель:** Расставить карточки мобов по слотам на полосах, построить станции, взаимодействовать со станциями для улучшения карточек.

На арене игроку доступен полет. Для расставления мобов игрок открывает GUI (`Tab`) и перетаскивает карточки на слоты:
- 3 полосы: LEFT, CENTER, RIGHT
- 15 слотов для выставления юнитов, но в начале игры доступны и видны только 4 (расположены сеткой 2x2)
- Покупать дополнительные слоты для выставления юнитов можно на научном столе прокачки дерева скиллов.
- Зеркалирование: «LEFT» для P1 = физически RIGHT на арене (для одинакового восприятия)

Дополнительно:
- **Зона строительства** за троном — можно ставить блоки, хранить вещи, выставлять столы прокачки и тп.
- **Колокол** — физический блок рядом с троном. Правый клик = «Готов». Повторный клик = «Больше не готов».
- **HP-маркеры** структур отображаются над башнями и троном.

### 2.4. Фаза Battle (Бой)

**Где:** Та же арена.
**Длительность:** Без лимита — до уничтожения трона или гибели всех мобов.
**Цель:** Наблюдать за боем (или отдать приказ отступить через колокол).

Механики боя:
- Мобы продвигаются по вейпоинтам: деплой → вражеская башня → вражеский трон.
- **Конфайнмент полос**: мобы физически не могут покинуть свою полосу.
- **Таргетинг**: сначала ближайший враг, затем вражеская структура.
- **Стейт-машина мобов**: IDLE, ADVANCING, FIGHTING, RETREATING, DEAD.
- **Детекция застревания**: если моб не двигается 3 секунды, он пропускает текущий вейпоинт.
- **Нокбэк**: зависит от направления удара, зажимается в границы полосы.
- **Башни** стреляют стрелами (`ArrowEntity`) по ближайшим врагам в радиусе.
- **Трон** наносит AoE-урон (расходящееся кольцо частиц, окрашенное в цвет команды).
- **Визуальные эффекты**: частицы урона (DAMAGE_INDICATOR, CRIT), анимация смерти (SOUL + SMOKE), цветные HP-бары (20 сегментов: зелёный → жёлтый → красный), деградация блоков структур при <50% HP.
- **Отступление** (колокол во время боя): мобы разворачиваются и бегут домой. Выжившие, дошедшие до своего места спавна возвращаются в карточки.
- **Смерть** финальна: моб не возвращается на руку, вся его экипировка теряется
- **Способности**: если у моба есть врожденная способность, то он сражается с помощью нее, а не в рукапашную. Пример: creeper вкрывается, нанося урон только врагам, не ломая блоки арены, blaze стреляет огнем на определенном радиусе от врага, ghast стреляет fireball, ведьма кидает зелья, warden использует sonic wave, удары пещерного паука отравляют и тп.

Grace period: когда все мобы погибли, 10-секундная пауза перед завершением раунда (чтобы увидеть результат).

### 2.5. Конец раунда

- Отступившие мобы возвращаются в инвентарь карточек.
- Урон по структурам накапливается между раундами (башни/троны не восстанавливаются).
- Статистика пишется в чат: урон трону, уничтоженные башни, урон башням.

### 2.6. Конец игры

- **Трон уничтожен** — мгновенная победа (в любом раунде).
- **После 3 раундов** — побеждает тот, кто нанёс больше урона трону.
- Тайбрейк: больше уничтоженных башен → больше урона башням → ничья.
- Экран результатов 15 секунд: заголовки VICTORY/DEFEAT/DRAW, фейерверки для победителя.
- После отображения результатов игроков выкидывает на главный экран, singleplayer мир для этой игры удаляется.

---

## 3. Система карточек

### 3.1. Получение

- Убей моба во время фазы Survival → получи карточку уровня 1.
- Бэби-зомби — отдельная карточка (`baby_zombie`).
- Бэби-пассивные мобы (телёнок, ягнёнок) — карточку не дают.
- Бэби-агрессивные и бэби-нейтральные мобы (пиглин, хоглин) — дают карточку своего взрослого типа.
- Мобы из спаунеров — не дают карточек.
- Слизнеподобные существа дают карточку своего убитого размера.

### 3.2. Свойства карточки

Каждая карточка определяется `MobCardDefinition`:

| Поле             | Описание                                                              |
|------------------|-----------------------------------------------------------------------|
| `entityType`     | Тип MC-сущности                                                       |
| `id`             | Уникальный строковый ID                                               |
| `displayName`    | Отображаемое имя                                                      |
| `hp`             | Здоровье при спавне на арене                                          |
| `speed`          | Скорость передвижения                                                 |
| `damage`         | Урон за удар                                                          |
| `attackCooldown` | Тиков между атаками                                                   |
| `canHaveWeapon`  | Может ли нести оружие                                                 |
| `canHaveArmor`   | Может ли носить броню                                                 |
| `canHavePotions` | Может ли иметь зелья и сколько                                        |
| `weaponTypes`    | Допустимые типы оружия                                                |
| `category`       | UNDEAD, ARTHROPOD, NETHER, END, ILLAGER, GOLEM, ANIMAL, SPECIAL, BOSS |

### 3.3. Категории мобов

| Категория | Примеры                       | Особенности                                                                  |
|-----------|-------------------------------|------------------------------------------------------------------------------|
| UNDEAD    | Зомби, Скелет, Визер-скелет   | Горят на солнце (если без головного убора), хилятся зельями урона и наоборот |
| ARTHROPOD | Паук, Пещерный паук           | Лёгкие, быстрые                                                              |
| NETHER    | Блейз, Гаст, Пиглин           | Врожденные способности дальнобойной атаки/сильные                            |
| END       | Эндермен, Шалкер, Эндермит    | Эндермен — высокий урон; Шалкер — снаряды                                    |
| ILLAGER   | Вындикатор, Разоритель        | Сильные ближники                                                             |
| GOLEM     | Железный голем, Снежный голем | Не могут быть улучшены до 2 уровня                                           |
| ANIMAL    | Волк, Пчела, Коза             | Почти все без урона, материал для жертвоприношений на столах                 |
| SPECIAL   | Крипер, Ведьма, Слизень       | Уникальные механики                                                          |
| BOSS      | Варден, Визер, Старший страж  | Очень редкие, очень сильные, уникальные атаки                                |

### 3.4. Мобы на арене

- Мобы продвигаются по своему лэйну от точки спавна до башни (если башня есть на лэйне), после разрушения башни до трона.
- По пути мобы атакуют вражеских мобов и сражеские постройки
- То как мобы сражаются должно быть красиво, у них должны быть коллайдеры, они не должны стоять друг в друге. При атаке мобы должны откидывать врагов. При атаке мечом должен проходить располовиненный сплэш-урон по соседним врагам. У мобов должна быть анимация атаки.
- Если выдать мобу оружение, то его характеристика урона прибавляется к базовому значению атаки карточки.
- Если выдать скелету лут - то он начнет стрелять с безопасного расстояния, а если меч - пойдет в ближний бой
- Нежить без головного урона горит под солнцем, ваниальная механика. Нужно чтобы этот урон наносился.
- Все летающие мобы передвигаются в 1 блоке над землей
- У мобов может быть либо обычное поведение в бою, либо, если есть уникальные способности, то поведение отличается:
  - Крипер взрывается, нанося урон только юнитам противника и урон по хп зданиям противника. AOE урон. Сам в процессе погибает.
  - Ифрит стреляет огнем, который наносит мгновенный урон + огонь дальше наносит DOT урон как горение под солнцем.
  - Гаст стреляет взрывающимися фаерболами, у них поведение такое же как у взрывов криперов - по хп противников и зданиям противников.
  - Ведьма кидается зельями из инвентаря, если зелий нет, то в ближнем бою + пьет ванильные хилящие/бафающие зелья сама.
  - Эндермер может телепортироваться на небольшие расстояния, заходя за спину противникам, атакуя их со спины.
  - Пауки могут перелезать преграды по пути - у них главная задача (если нет юнитов врага по пути) - дойти до трона и атаковать его.
  - Вызыватель может призвать до 3 вексов, которые будут доп юнитами на лэйне. Также у него есть атака заклинанием.
  - У стражей, вардена, визера, снежного голема и других мобов свои уникальные ваниальные атаки, надо все это использовать.
- Водные мобы, которым нужен кислород, задыхаются без воды (ванильная механика, должно и так работать)

---

## 4. Арена

### 4.1. Размеры

Для MVP будет достаточно автоматической генерации карты арены, а полноценная версия игры будет уже на построенной мной карте.

- Длина полосы: ~36 блоков
- Ширина полосы: 5 блоков
- Расстояние между центрами полос: 15 блоков
- Стены между полосами
- Освещение по всей арене
- На открытом воздухе

### 4.2. Структуры

| Структура | Кол-во       | HP   | Атака                               | Описание                           |
|-----------|--------------|------|-------------------------------------|------------------------------------|
| Трон      | 1 на команду | 1000 | AoE 5 dmg, 10 range, 30 cooldown    | Главная цель. Уничтожение = победа |
| Башня     | 2 на команду | 250  | Стрела 5 dmg, 20 range, 30 cooldown | Покрывает свою полосу + центр      |

### 4.2.1. Башни
Башни атакуют одну цель, которая ближе всего к себе. Стрела вылетает из башни, попадает в цель и удаляется, не отскакивая от нее визуально.

### 4.2.2. Трон
Трон атакует AOE атакой (если есть моб в зоне атаки), уничтожая всех вокруг себя.

### 4.3. Зоны

- **Зоны деплоя** — слоты на каждой полосе рядом с дружественной стороной. Для старта/MVP 4 слота сеткой 2x2, в полноценной игре можно покупать доп места вплоть до 5x3.
- **Зоны строительства** — за троном - для столов улучшения.
- **Пьедестал колокола** — колокол рядом с каждым троном.

---

## 5. Пользовательский интерфейс

Референсы для хорошего стиля визуальных эффектов и пользовательского интерфейса - Destiny 2, Dota 2, Deadlock, Overwatch.  
У полноэкранных окон должен быть заблюренный фон (ванильная механика)

### 5.1. HUD

- **Таймер** с цветовой анимацией (белый → оранжевый → красное пульсирование).
- **Индикатор фазы** с иконкой.
- **Пипки раундов** (завершён / текущий / будущий).
- **Индикатор LIVE** во время боя (пульсирующая красная точка).
- **Напоминание о колоколе** во время подготовки.
- **Оверлей GAME OVER** с результатом.

### 5.2. Экраны

- **ConnectScreen** — ввод IP, подключение по TCP, статус лобби, кнопки connect, disconnect, join (используется если игрок вышел в главное меню, и хочет вернуться в игру, а так игра стартует автоматически при подключении необходимого кол-ва игроков)
- **CardScreen** — просмотр инвентаря карточек.
- **DeploymentScreen** — расстановка мобов на арене (drag & drop карточек по слотам).

### 5.3. Хоткеи

| Клавиша | Действие                       |
|---------|--------------------------------|
| `Tab`   | Открыть карточки / расстановку |

---

## 6. Сетевая архитектура

### 6.1. Почему гибрид TCP + MC

- Во время Survival-фазы игроки в синглплеере. MC-сервер им не нужен.
- TCP-соединение остаётся активным всё время — синхронизирует карточки, таймер, чат, можно поставить игру на паузу.
- MC-сервер нужен только для визуализации арены (Preparation + Battle).
- Это позволяет играть на выделенном сервере без необходимости держать два мира на одном MC-сервере.
- Команды /ac написанные в чате одиночной игре ретранслируются на сервер и вызываются там, ответ приходит игроку в чат.

### 6.2. Протокол (SyncProtocol)

JSON-сообщения через TCP-сокет с length-prefix:

**Server → Client:**
- `WELCOME` — ID сессии, MC-порт
- `LOBBY_UPDATE` — количество игроков, статус
- `PHASE_CHANGE` — фаза, раунд, таймер
- `TIMER_SYNC` — обновление таймера каждую секунду
- `CONNECT_TO_MC` — хост:порт для подключения к MC
- `RETURN_TO_SINGLE` — вернуться в сингл
- `CARD_SYNC` — полный инвентарь карточек (SNBT)
- `GAME_SEED` — сид для создания мира
- `GAME_RESULT` — победитель + детали
- `CHAT_RELAY` — сообщение от другого игрока
- `RECONNECT_STATE` — полное состояние для реконнекта
- `INVENTORY_SYNC` — инвентарь для восстановления

**Client → Server:**
- `AUTH` — имя, UUID
- `CARD_OBTAINED` — ID убитого моба
- `READY` — готов к бою
- `PLACE_CARD` / `REMOVE_CARD` — управление деплоем
- `BELL_RING` — готов / отступление
- `CHAT` — сообщение
- `WORLD_READY` — мир создан
- `INVENTORY_SYNC` — инвентарь перед переходом на арену
- `PAUSE_STATE` — игрок на паузе (ESC)

---

## 7. Конфигурация

Все параметры настраиваются через `/ac config` или файл `config/arenaclash.json`:

| Параметр               | По умолчанию | Описание                            |
|------------------------|--------------|-------------------------------------|
| `dayDurationTicks`     | 6000         | Длина игрового дня (ванила: 24000)  |
| `preparationTimeTicks` | 3600         | Время на подготовку (3 мин)         |
| `maxRounds`            | 3            | Количество раундов                  |
| `gameSeed`             | 0            | Сид мира (0 = случайный)            |
| `towerHP`              | 250          | HP башни                            |
| `throneHP`             | 1000         | HP трона                            |
| `towerDamage`          | 5.0          | Урон башни                          |
| `towerRange`           | 20           | Радиус атаки башни                  |
| `towerAttackCooldown`  | 30           | Кулдаун башни (тики)                |
| `throneAoeDamage`      | 5.0          | AoE-урон трона                      |
| `throneAoeRange`       | 10           | Радиус AoE трона                    |
| `throneAttackCooldown` | 30           | Кулдаун трона (тики)                |
| `knockbackStrength`    | 1            | Сила нокбэка                        |
| `mobAggroRange`        | 8.0          | Радиус агра мобов                   |
| `deploymentSlots`      | 4            | Сколько начальных слотов для юнитов |

и еще некоторые параметры не представлены в таблице
---

## 8. Будущие планы (Post-MVP)

### 8.1. Система прокачки карточек
- Мёрдж одинаковых карточек для повышения уровня.
- Левелапы линейно повышают HP, урон. (zombie 3 lvl = 3 * zombie 1 lvl)

### 8.2. Мастерские (Уникальные столы)
Эти столы нельзя выставить в выживании, можно поставить только на арене в специальной зоне.  
- Стол для объединения одинаковых карточек для повышения уровня.
- Стол для экипировки мобов оружием/бронёй
- Стол зачарования оружия/брони (покупка выбранного зачарования и его уровня за лазурит)
- Стол для доступа к дереву прокачки (там покупки осуществляются за уровни опыта)
- Стол для жертвоприношения карточек взамен на опыт

### 8.2.1. Стол улучшения карточек
На нем игрок может объединить одинаковые карточки с одинаковыми уровнями чтобы получить карточку большего уровня:  
Zombie 1 lvl + Zombie 1 lvl = Zombie 2 lvl  
Zombie 2 lvl + Zombie 2 lvl = Zombie 3 lvl  
Mob N lvl + Mob N lvl = Mob N+1 lvl  
Прокачка происходит путем умножения уровня существа на его базовый стат хп, урона: Если у моба на 1 lvl 10 hp и 2 урона, то на 3 lvl у него 30 hp и 6 урона.

### 8.2.2. Стол экипоровки
На нем можно дать карточке моба оружие в руку, надеть броню. Но только если у моба есть такие слоты и дается подходящее оружие. Можно еще дать зелья - для ведьмы (3 слота) и для крипера (1 слот). Крипер сразу получает эффект этого зелья и после взрыва на несколько секунд этот эффект остается на земле lingering эффектом (ваниальная механика), нужно чтобы если этот эффект положительный, то он сразу действовал на крипера и после смерти крипера только на союзников в облаке эффекта, а если эффект отрицательный, то на крипера бы не действал, а облако действовало только на врагов. У ведьмы 3 слота для зелий - они будут выкидываться по-очереди, но не тратиться, то есть ведьма по кд кидает зелья 1, 2, 3, потом снова 1 и тд пока не умрет.  

### 8.2.3. Стол зачарования
Это обычный стол зачарования, рецепт не изменен, но если открыть его, то будет кастомный GUI где есть стол для предмета, а после выставления предмета есть двухъярусный список доступных на него зачарований, где второй ярус это уровень зачарования. Там покупается зачарование на предметы не за опыт, а за определенное количество лазурита.

### 8.2.4. Стол доступа к дереву прокачки
Тут игрок может потратить уровни опыта на покупку различных плюшек. Например, доп. места для выставления мобов.

### 8.2.5. Стол жертвоприношения
У игроков будет большое количество мусорных или лишних карточек, которые они не могут выставить. На этом столе можно их жертвовать на опыт.

### 8.2.6. Стол покупки заклинаний / способностей
Игрок может купить заклинания как свитки себе в инвентарь и активировать их позже.

### 8.3. Заклинания / Способности
Покупаются на столе заклинаний
- Активные заклинания во время боя (удар молнией, лечение, ускорение).
- Активные проклятья во время выживания на другого игрока.

### 8.4. Защитные постройки
- Игрок строит баррикады, ловушки, турели в зоне строительства.
- Ресурсы из Survival используются для крафта оборонительных блоков/башен.

### 8.5. Режимы игры
- 2v2 (командный).
- FFA (каждый сам за себя, сражения 1vs1 с разными противниками в разных раундах) на 4 игроков.
- Нужно придумать режим на 3 игроков.

### 8.6. Визуальные улучшения
- 3D-рендеринг карточек с моделью моба.
- Анимация получения карточки (тотем-эффект).
- Спектатор-режим для зрителей.

### 8.7. Система опыта
- Изменить чтобы каждый уровень получался за одинаковое количество опыта, а не как в ваниле
- Игроки получают опыт следующими способами:
  - 1 уровень за каждого умершего моба на арене
  - Сколько-то опыта за жертвоприношение моба на столе жертвоприношения (более мощные мобы дают больше опыта)
  - Выполнение квестов в выживании (читай пункт 8.8)

### 8.8. Система квестов
Это дополнительный способ заработать уровни опыта. За выполнение квестов выдается сразу несколько уровней.  
Квест активный 1 для 1 игрока, у игроков личные квесты и никак не связаны с другими игроками. Купить доп активный слот для квеста можно в дереве прокачки.  
Как только квест будет выполнен - выбирается следующий квест. Также квест меняется после фазы арены.  
Какие могут быть квесты:
- Упасть со 100+ блоков высоты и выжить
- Потрогать бедрок
- Вскопать алмаз
- Приручить животное
- Размножить животных
- Сломать железный инструмент (в том числе скрафченный из железа, то есть и ножницы и огниво считаются)
- Получить глазурированную терракоту
- Поймать рыбу удочкой
- Получить эффект отравления
- Поджечь портал в ад
- Поджечь тнт
- Подписать книгу
- И много других вариантов...

Разные квесты разной сложности, так что и награда разная.

### 8.9. Сделать красивый интерфейс, эффекты
Нужно улучшать визуальный стиль игры, сейчас шапка с таймером с градиентным фотом выполнена красиво, нужно чтобы интерфейсы были не хуже ее по стилю. Нужно использовать кастомные нарисованные визуальные ассеты.

---

## 9. Известные ограничения MVP

- Карточки не прокачиваются (уровень всегда 1).
- Мобы не экипируются оружием/бронёй.
- Нет столов.
- Нет заклинаний.
- Нет спектатор-режима для третьих лиц.
- Фейерверки победителя спавнятся через Thread.sleep (стоит переделать на серверный тик).
- `cleanupStaleSessions()` в TCP-сервере не реализован полностью (placeholder).
