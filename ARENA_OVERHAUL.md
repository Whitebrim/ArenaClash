# Arena Clash v2 — Arena & Combat Overhaul

## Содержание
1. [Система арены на основе данных](#1-система-арены)
2. [Строительство карты](#2-строительство-карты)
3. [Боевая система](#3-боевая-система)
4. [Визуальные эффекты](#4-визуальные-эффекты)
5. [Колокол](#5-колокол)
6. [Текстуры/ресурсы для создания](#6-текстуры)
7. [Как развернуть](#7-развертывание)

---

## 1. Система арены

### Подход: Мир-шаблон + JSON-определение

Вместо генерации арены из кода используем **мир-шаблон (template world)** + **JSON-файл определения арены** (`arena_definition.json`).

**Почему:**
- Полная свобода в дизайне карты — кривые лэйны, красивая архитектура, любой ландшафт
- Быстрая перезагрузка — просто копируем папку мира
- Разделение данных и логики — JSON описывает где что, мир хранит блоки

**Как работает:**
```
config/arenaclash/
├── arena_definition.json    ← Все позиции, вэйпоинты, зоны
└── arena_template/          ← Копия мира-шаблона (или имя в saves/)
```

### JSON-определение арены

```json
{
  "templateWorldName": "arena_template",
  "boundsMin": {"x": -50, "y": 98, "z": -80},
  "boundsMax": {"x": 50, "y": 120, "z": 80},
  
  "player1Spawn": {"x": 0.5, "y": 101, "z": -65.5},
  "player2Spawn": {"x": 0.5, "y": 101, "z": 65.5},
  
  "player1Bell": {"x": 3, "y": 101, "z": -60},
  "player2Bell": {"x": 3, "y": 101, "z": 60},
  
  "player1Throne": {
    "position": {"x": 0, "y": 100, "z": -60},
    "boundsMin": {"x": -2, "y": 100, "z": -62},
    "boundsMax": {"x": 2, "y": 105, "z": -58},
    "hp": 200, "attackRange": 6, "attackDamage": 5, "attackCooldown": 30
  },
  
  "player1Towers": [
    {
      "position": {"x": -15, "y": 100, "z": -57},
      "boundsMin": {"x": -16, "y": 100, "z": -58},
      "boundsMax": {"x": -14, "y": 104, "z": -56},
      "hp": 100, "attackRange": 15, "attackDamage": 3, "attackCooldown": 40,
      "associatedLane": "LEFT"
    }
  ],
  
  "lanes": {
    "LEFT": {
      "width": 5,
      "waypoints": [
        {"x": -15.5, "y": 100, "z": -48.5},
        {"x": -14.5, "y": 100, "z": -35.5},
        {"x": -12.5, "y": 100, "z": -20.5},
        {"x": -13.5, "y": 100, "z": -5.5},
        {"x": -15.5, "y": 100, "z": 5.5},
        {"x": -14.5, "y": 100, "z": 20.5},
        {"x": -15.5, "y": 100, "z": 48.5}
      ],
      "deployP1": [
        {"x": -16, "y": 100, "z": -50},
        {"x": -15, "y": 100, "z": -50},
        {"x": -16, "y": 100, "z": -49},
        {"x": -15, "y": 100, "z": -49}
      ],
      "deployP2": [...]
    }
  }
}
```

### Команды для разметки арены

Все команды начинаются с `/ac arena`:

| Команда | Описание |
|---------|----------|
| `/ac arena wand` | Даёт палочку для выделения зон (как WorldEdit) |
| `/ac arena setspawn <p1\|p2>` | Ставит спавн игрока на текущей позиции |
| `/ac arena setbell <p1\|p2>` | Ставит позицию колокола |
| `/ac arena setthrone <p1\|p2>` | Ставит трон (pos1→pos2 = bounds) |
| `/ac arena addtower <p1\|p2> <lane>` | Добавляет башню |
| `/ac arena waypoint <lane> <index>` | Добавляет вэйпоинт к лэйну |
| `/ac arena clearwaypoints <lane>` | Очищает вэйпоинты лэйна |
| `/ac arena deploy <lane> <p1\|p2> <slot>` | Ставит слот деплоя |
| `/ac arena bounds` | Ставит границы арены (pos1→pos2) |
| `/ac arena buildzone <p1\|p2>` | Добавляет зону строительства |
| `/ac arena save` | Сохраняет в JSON |
| `/ac arena load` | Загружает из JSON |
| `/ac arena show` | Переключает визуализацию зон |
| `/ac arena savetemplate` | Сохраняет текущий мир как шаблон |

### Визуализация зон

При `/ac arena show` включается рендеринг границ на клиенте:
- **Зелёные линии** — лэйн LEFT с вэйпоинтами
- **Жёлтые линии** — лэйн CENTER
- **Красные линии** — лэйн RIGHT
- **Синие блоки** — зоны деплоя P1
- **Красные блоки** — зоны деплоя P2
- **Золотой контур** — трон
- **Серый контур** — башни
- **Бирюзовый контур** — зоны строительства
- **Белый контур** — границы арены

Реализация: клиентский рендерер через `WorldRenderEvents.AFTER_ENTITIES`, рисует через `VertexConsumer` обводку и линии. Координаты приходят с сервера через пакет.

---

## 2. Строительство карты

### Пошаговая инструкция для вас:

1. **Создайте мир** в креативе с желаемой картой арены
2. **Постройте**: дорожки (лэйны), башни, троны, базы, колокола, освещение
3. **Установите мод** и зайдите с OP-правами
4. **Разметьте** командами `/ac arena`:
   - Начните с границ: `/ac arena wand`, выделите углы, `/ac arena bounds`
   - Поставьте спавны, колокола
   - Разметьте троны и башни с bounding box
   - **Важно**: для вэйпоинтов пройдитесь по каждому лэйну и ставьте точки каждые 5-10 блоков. Лэйны могут быть кривыми!
   - Разметьте слоты деплоя (2x2 перед каждым лэйном)
5. `/ac arena save` — сохраняет `arena_definition.json`
6. `/ac arena savetemplate` — копирует текущий мир как шаблон
7. При каждой новой игре: мир копируется из шаблона, арена чистая

### Рекомендации по дизайну карты:

- **Лэйны**: дорожки шириной 5-7 блоков. Делайте изгибы и повороты — вэйпоинты поддерживают кривые
- **Боковые ограждения**: не обязательны! Мод использует invisible barrier (барьерные блоки ставить не нужно — мобы виртуально ограничены в зоне лэйна)
- **Башни**: размер 3x3 до 5x5 base. Блоки любые. Можно со стрельбицами
- **Трон**: 5x5 или больше, впечатляющая структура. Он наносит AoE урон
- **Центр**: мост или переход, можно с декорацией
- **Колокол**: поставьте блок колокола (`bell`) на каждой базе — игрок звонит в него правым кликом
- **Освещение**: sea_lantern, glowstone, факелы — по вкусу
- **Зоны строительства**: отметьте участки где игрок может строить (вдоль своих лэйнов)

---

## 3. Боевая система (полная переработка)

### Ключевые изменения:

#### Движение мобов
- **AI не отключается полностью** — используем `setAiDisabled(false)` но очищаем все Goals и добавляем свои кастомные
- Мобы следуют по вэйпоинтам используя обычное передвижение Minecraft (навигация)
- Если навигация не работает (слишком далеко, stuck) — fallback на `requestTeleport`
- **Граница лэйна**: каждый тик проверяем позицию моба, если выходит за границу — корректируем

#### Сражение
- Мобы используют **настоящие атаки Minecraft** с анимациями свинга
- `LivingEntity.swingHand()` для анимации удара
- `LivingEntity.damage()` для нанесения урона (вместо setHealth)
- Это даёт **hurtTime** анимацию (красная вспышка при получении урона)
- **Knockback**: реальный, через `takeKnockback()`, но с `clampToLane()` чтобы не улетел за дорожку

#### Специальные мобы
| Моб | Механика |
|-----|----------|
| Creeper | При контакте с врагом — AoE взрыв без урона блокам. Умирает. Визуальный взрыв + частицы |
| Bee | Жалит с анимацией, не теряет жало (кулдаун вместо смерти). Маленькие жёлтые частицы |
| Skeleton/Stray | Если имеет лук — стреляет стрелами (ranged AI). Без лука — мили |
| Blaze | Огненные шары (визуальные, AoE при попадании) |
| Ghast | Файерболы (визуальные) |
| Witch | Зелья (визуальный бросок, AoE дебафф зона) |
| Iron Golem | Подбрасывает врагов вверх при ударе. Мощный нокбэк |
| Enderman | Телепортация к цели (эффект телепорта) |
| Wolf | Быстрые серии атак |
| Ravager | Разрушительный charge-атака |

#### Башни
- Стреляют **настоящими стрелами** (ArrowEntity) в ближайшего врага на своём лэйне + центральном
- Стрелы видны всем, летят по дуге, наносят урон при попадании
- Визуально: стрелы spawn из верхушки башни
- Звук: `entity.arrow.shoot`

#### Трон
- **AoE shockwave**: визуальная волна (colored dust particles) расширяющаяся от трона
- Звук: `entity.warden.sonic_boom` на низкой громкости
- Наносит урон всем врагам в радиусе с falloff по расстоянию
- Лёгкий knockback от трона

---

## 4. Визуальные эффекты

### HP-бар над мобами и структурами

**Вместо** ASCII текста в custom name используем **клиентский рендерер** через `EntityRenderEvents`:

```
┌──────────────────────────┐
│  ⚔ Zombie Lv.2  [P1]    │  ← Имя моба + уровень + команда
│  ████████████░░░░  75/100│  ← Цветной HP бар с числами
└──────────────────────────┘
```

**Реализация**: `HealthBarRenderer` подключается к `WorldRenderEvents.AFTER_ENTITIES`:
- Для каждого моба с тегом `arenaclash_mob` рисует бар
- Для каждой структуры — отдельный бар у позиции
- Бар: градиент зелёный→жёлтый→красный в зависимости от %HP
- Фон: полупрозрачная чёрная плашка
- Стиль: вдохновлён Dota 2 / Deadlock health bars
- Масштабируется по расстоянию до камеры

### Floating Damage Numbers

При каждом нанесении урона:
1. Спавнится невидимый armor_stand с числом урона в custom name
2. Armor stand поднимается вверх (velocity Y) и исчезает через 20 тиков
3. Цвет: **белый** для физического урона, **фиолетовый** для магического, **оранжевый** для AoE

**Серверная реализация** (DamageNumberManager):
```java
// Spawn armor stand with damage number
// Tick: move up + fade after 1 second
// Remove entity
```

### Эффекты частиц
- **При ударе**: `DAMAGE_INDICATOR` + `CRIT`
- **При убийстве**: `SOUL` + `SMOKE` + звук
- **Взрыв крипера**: `EXPLOSION_EMITTER` + `FLAME` + `SMOKE`
- **Жало пчелы**: `FALLING_SPORE_BLOSSOM`
- **Стрела башни**: видимая стрела-сущность
- **AoE трона**: `DustParticleEffect` кольцом
- **Уничтожение структуры**: `EXPLOSION` + блоки разлетаются

---

## 5. Колокол

### Механика:
- В JSON указывается позиция блока `bell` для каждого игрока
- При клике ПКМ по блоку `bell` **на своей базе**:
  - Проверяется команда игрока и позиция
  - В PREPARATION: отмечает Ready
  - В BATTLE: приказ отступать
- Визуал: анимация колокола (ванильная) + звук + broadcast сообщение
- **Кнопка B убрана** — только физический колокол

### Реализация:
```java
// В GameEventHandlers: UseBlockCallback
// Если блок == bell && позиция совпадает с arena_definition.bellPos
// → handleBellRing(player)
```

---

## 6. Текстуры/ресурсы для создания

Следующие текстуры нужно нарисовать для мода:

### GUI
1. **card_background.png** (128x196) — фон карточки моба для GUI
2. **card_frame_common.png** — рамка для обычных мобов
3. **card_frame_rare.png** — рамка для редких (Nether/End)
4. **card_frame_boss.png** — рамка для боссов
5. **slot_empty.png** (40x40) — пустой слот деплоя
6. **slot_filled.png** — заполненный слот
7. **hud_phase_bar.png** — полоска фазы вверху экрана

### HUD
8. **healthbar_bg.png** (64x8) — фон HP-бара
9. **healthbar_fill.png** (64x8) — заполнение HP-бара (будет тонирован программно)
10. **healthbar_frame.png** (68x12) — рамка HP-бара

### Иконки
11. **icon_hp.png** (8x8) — иконка сердца
12. **icon_attack.png** (8x8) — иконка атаки
13. **icon_speed.png** (8x8) — иконка скорости
14. **icon_bell.png** (16x16) — иконка колокола для HUD

Пока мод использует **программную отрисовку** без кастомных текстур (DrawContext.fill + drawText). Текстуры можно подключить позже через ресурспак.

---

## 7. Развертывание

### Новый игровой цикл:

1. `/ac start` → проверяет наличие `arena_definition.json`
2. Копирует мир-шаблон в новую папку `ArenaClash_game_<timestamp>`
3. SURVIVAL фаза — игроки в синглплеере
4. PREPARATION — игроки подключаются к серверу, TP на арену
5. Игроки деплоят мобов, строят в своих зонах
6. Звонят в колокол → Ready
7. BATTLE — мобы идут по вэйпоинтам, сражаются, башни стреляют
8. ROUND_END → подсчёт
9. Повтор или GAME_OVER

### Очистка:
- `/ac reset` — удаляет текущий мир игры
- Шаблон остаётся нетронутым
- При новом `/ac start` — свежая копия

---

## Список изменённых файлов

### Новые файлы:
- `arena/ArenaDefinition.java` — JSON-based arena config
- `ai/DamageNumberManager.java` — Floating damage numbers
- `command/ArenaSetupCommands.java` — Arena building tools
- `client/render/HealthBarRenderer.java` — Beautiful HP bars
- `client/render/ArenaZoneRenderer.java` — Zone visualization for builders

### Полностью переписанные:
- `ai/CombatSystem.java` — With animations, lane knockback, effects
- `arena/ArenaMob.java` — Proper pathfinding, lane enforcement
- `arena/ArenaStructure.java` — Real arrows, AoE visuals
- `arena/ArenaManager.java` — Uses ArenaDefinition, new combat
- `arena/Lane.java` — Updated for data-driven waypoints
- `client/render/GameHudRenderer.java` — Better phase HUD
- `arena/ArenaBuilder.java` → DELETED (replaced by template world)
- `ai/LanePathfinder.java` → DELETED (waypoints from JSON)

### Модифицированные:
- `event/GameEventHandlers.java` — Bell block interaction
- `game/GameManager.java` — Uses ArenaDefinition, template worlds
- `config/GameConfig.java` — New arena config options
